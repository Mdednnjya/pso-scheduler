name: ğŸš€ Dietify API Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      reason:
        description: 'Deployment reason'
        required: false
        default: 'Manual deployment'

jobs:
  deploy:
    name: ğŸ¯ Deploy to Campus VM
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ³ Test Docker Build
        run: |
          echo "Testing Docker build locally..."
          docker build -t dietify-api:test .
          echo "âœ… Docker build successful"

      - name: ğŸš€ Deploy to VM
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          password: ${{ secrets.VM_PASSWORD }}
          port: 22
          script: |
            echo "ğŸ”„ Starting deployment..."
            
            # Navigate or create project directory
            cd /home/group2
            
            # Clone/update repository
            if [ -d "dietify-api" ]; then
              echo "ğŸ“ Updating existing repository..."
              cd dietify-api
              git pull origin main
            else
              echo "ğŸ“¥ Cloning repository..."
              git clone https://github.com/${{ github.repository }}.git dietify-api
              cd dietify-api
            fi
            
            # Ensure Docker is running
            sudo systemctl start docker
            
            # Stop existing containers (if any)
            echo "ğŸ›‘ Stopping existing containers..."
            docker-compose down --remove-orphans || true
            
            # Remove old images to save space
            echo "ğŸ§¹ Cleaning up old images..."
            docker system prune -f || true
            
            # Build and start new containers
            echo "ğŸ—ï¸ Building and starting containers..."
            docker-compose up --build -d
            
            # Wait for services to start
            echo "â³ Waiting for services to start..."
            sleep 30
            
            # Health check
            echo "ğŸ” Performing health check..."
            if curl -f http://localhost:8000/api/v1/health; then
              echo "âœ… Deployment successful!"
              echo "ğŸŒ API available at: http://${{ secrets.VM_HOST }}:8000"
            else
              echo "âŒ Health check failed!"
              docker-compose logs
              exit 1
            fi

      - name: ğŸ’¬ Discord Success Notification
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
               -d '{
                 "embeds": [{
                   "title": "âœ… Dietify API Deployed Successfully!",
                   "description": "ğŸš€ Latest changes deployed to Campus VM",
                   "color": 65280,
                   "fields": [
                     {"name": "ğŸŒ API URL", "value": "http://${{ secrets.VM_HOST }}:8000", "inline": true},
                     {"name": "ğŸ“Š Health Check", "value": "http://${{ secrets.VM_HOST }}:8000/api/v1/health", "inline": true},
                     {"name": "ğŸ“– Docs", "value": "http://${{ secrets.VM_HOST }}:8000/docs", "inline": true},
                     {"name": "ğŸ”§ Commit", "value": "`${{ github.sha }}`", "inline": false}
                   ],
                   "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)'"
                 }]
               }' \
               ${{ secrets.DISCORD_WEBHOOK }}

      - name: ğŸ’¬ Discord Failure Notification
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
               -d '{
                 "embeds": [{
                   "title": "âŒ Dietify API Deployment Failed!",
                   "description": "ğŸš¨ Deployment to Campus VM encountered errors",
                   "color": 16711680,
                   "fields": [
                     {"name": "ğŸ”§ Commit", "value": "`${{ github.sha }}`", "inline": true},
                     {"name": "ğŸŒ Check Logs", "value": "https://github.com/${{ github.repository }}/actions", "inline": true}
                   ],
                   "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)'"
                 }]
               }' \
               ${{ secrets.DISCORD_WEBHOOK }}